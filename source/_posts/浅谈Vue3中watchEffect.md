---
title: æµ…è°ˆVue3ä¸­watchEffect
date: 2022-05-02 18:50:38
tags: vue3
---

## å‰è¨€
`watchEffect`ï¼Œå®ƒç«‹å³æ‰§è¡Œä¼ å…¥çš„ä¸€ä¸ªå‡½æ•°ï¼ŒåŒæ—¶å“åº”å¼è¿½è¸ªå…¶ä¾èµ–ï¼Œå¹¶åœ¨å…¶ä¾èµ–å˜æ›´æ—¶é‡æ–°è¿è¡Œè¯¥å‡½æ•°ã€‚

æ¢å¥è¯è¯´ï¼š`watchEffect`ç›¸å½“äºå°†`watch`Â çš„ä¾èµ–æºå’Œå›è°ƒå‡½æ•°åˆå¹¶ï¼Œå½“ä»»ä½•ä½ æœ‰ç”¨åˆ°çš„å“åº”å¼ä¾èµ–æ›´æ–°æ—¶ï¼Œè¯¥å›è°ƒå‡½æ•°ä¾¿ä¼šé‡æ–°æ‰§è¡Œã€‚ä¸åŒäºÂ `watch`ï¼Œ`watchEffect`Â çš„å›è°ƒå‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼ˆå³Â `{ immediate: true }`ï¼‰

æ­¤æ–‡ä¸»è¦è®²è¿°æ€æ ·åˆ©ç”¨`æ¸…é™¤å‰¯ä½œç”¨`ä½¿æˆ‘ä»¬çš„ä»£ç æ›´åŠ ä¼˜é›…~

## watchEffectçš„å‰¯ä½œç”¨

ä»€ä¹ˆæ˜¯å‰¯ä½œç”¨ï¼ˆ`side effect`ï¼‰ï¼Œç®€å•çš„è¯´å‰¯ä½œç”¨å°±æ˜¯æ‰§è¡ŒæŸç§æ“ä½œï¼Œå¦‚å¯¹å¤–éƒ¨å¯å˜æ•°æ®æˆ–å˜é‡çš„ä¿®æ”¹ï¼Œå¤–éƒ¨æ¥å£çš„è°ƒç”¨ç­‰ã€‚`watchEffect`çš„å›è°ƒå‡½æ•°å°±æ˜¯ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨`watchEffect`å°±æ˜¯ä¾¦å¬åˆ°ä¾èµ–çš„å˜åŒ–åæ‰§è¡ŒæŸäº›æ“ä½œã€‚

å½“æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå®ƒåŠ¿å¿…ä¼šå¯¹ç³»ç»Ÿå¸¦æ¥ä¸€äº›å½±å“ï¼Œå¦‚åœ¨å‰¯ä½œç”¨å‡½æ•°é‡Œæ‰§è¡Œäº†ä¸€ä¸ªå®šæ—¶å™¨`setInterval`ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å¤„ç†å‰¯ä½œç”¨ã€‚
`Vue3`çš„`watchEffect`ä¾¦å¬å‰¯ä½œç”¨ä¼ å…¥çš„å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ªÂ `onInvalidate`Â å‡½æ•°ä½œä¸ºå…¥å‚ï¼Œç”¨æ¥æ³¨å†Œæ¸…ç†å¤±æ•ˆæ—¶çš„å›è°ƒã€‚å½“ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå¤±æ•ˆå›è°ƒä¼šè¢«è§¦å‘ï¼š
-   å‰¯ä½œç”¨å³å°†é‡æ–°æ‰§è¡Œæ—¶ï¼ˆå³ä¾èµ–çš„å€¼æ”¹å˜ï¼‰
-   ä¾¦å¬å™¨è¢«åœæ­¢ (é€šè¿‡æ˜¾ç¤ºè°ƒç”¨è¿”å›å€¼åœæ­¢ä¾¦å¬ï¼Œæˆ–ç»„ä»¶è¢«å¸è½½æ—¶éšå¼è°ƒç”¨äº†åœæ­¢ä¾¦å¬)

```js
import { watchEffect, ref } from 'vue'

const count = ref(0)
watchEffect((onInvalidate) => {
  console.log(count.value)
  onInvalidate(() => {
    console.log('æ‰§è¡Œäº†onInvalidate')
  })
})

setTimeout(()=> {
  count.value++
}, 1000)
```

ä¸Šè¿°ä»£ç æ‰“å°çš„é¡ºåºä¸ºï¼š `0` -> `æ‰§è¡Œäº†onInvalidateï¼Œæœ€åæ‰§è¡Œ` -> `1`

åˆ†æï¼šåˆå§‹åŒ–æ—¶å…ˆæ‰“å°`count`çš„å€¼`0`ï¼Œ ç„¶åç”±äºå®šæ—¶å™¨æŠŠ`count`çš„å€¼æ›´æ–°ä¸º`1`, æ­¤æ—¶å‰¯ä½œç”¨å³å°†é‡æ–°æ‰§è¡Œï¼Œå› æ­¤`onInvalidate`çš„å›è°ƒå‡½æ•°ä¼šè¢«è§¦å‘ï¼Œæ‰“å°`æ‰§è¡Œäº†onInvalidate`ï¼Œç„¶åæ‰§è¡Œäº†å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‰“å°`count`çš„å€¼`1`ã€‚

```js
import { watchEffect, ref } from 'vue'

const count = ref(0)
const stop = watchEffect((onInvalidate) => {
  console.log(count.value)
  onInvalidate(() => {
    console.log('æ‰§è¡Œäº†onInvalidate')
  })
})

setTimeout(()=> {
  stop()
}, 1000)
```
ä¸Šè¿°ä»£ç ï¼šå½“æˆ‘ä»¬æ˜¾ç¤ºæ‰§è¡Œ`stop`å‡½æ•°åœæ­¢ä¾¦å¬ï¼Œæ­¤æ—¶ä¹Ÿä¼šè§¦å‘`onInvalidate`çš„å›è°ƒå‡½æ•°ã€‚åŒæ ·ï¼Œ`watchEffect`**æ‰€åœ¨çš„ç»„ä»¶è¢«å¸è½½æ—¶**ä¼šéšå¼è°ƒç”¨`stop`å‡½æ•°åœæ­¢ä¾¦å¬ï¼Œæ•…ä¹Ÿèƒ½è§¦å‘`onInvalidate`çš„å›è°ƒå‡½æ•°ã€‚

## watchEffectçš„åº”ç”¨
åˆ©ç”¨`watchEffect`çš„éæƒ°æ€§æ‰§è¡Œï¼Œä»¥åŠä¼ å…¥çš„`onInvalidate`Â å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åšä»€ä¹ˆäº‹æƒ…äº†ï¼Ÿ

**åœºæ™¯ä¸€**ï¼šå¹³æ—¶æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæˆ–è€…ç›‘å¬æŸä¸ªäº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨`mounted`ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°å†…å®šä¹‰æˆ–è€…æ³¨å†Œï¼Œç„¶åç»„ä»¶é”€æ¯ä¹‹å‰åœ¨`beforeUnmount`é’©å­å‡½æ•°é‡Œæ¸…é™¤å®šæ—¶å™¨æˆ–å–æ¶ˆç›‘å¬ã€‚è¿™æ ·åšæˆ‘ä»¬çš„é€»è¾‘è¢«åˆ†æ•£åœ¨ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¸åˆ©äºç»´æŠ¤å’Œé˜…è¯»ã€‚

å¦‚æœæˆ‘åˆ©ç”¨`watchEffect`ï¼Œåˆ›é€ å’Œé”€æ¯é€»è¾‘æ”¾åœ¨äº†ä¸€èµ·ï¼Œæ­¤æ—¶ä»£ç æ›´åŠ ä¼˜é›…æ˜“è¯»~

```js
// å®šæ—¶å™¨æ³¨å†Œå’Œé”€æ¯
watchEffect((onInvalidate) => {
  const timer = setInterval(()=> {
    // ...
  }, 1000)
  onInvalidate(() => clearInterval(timer))
})

const handleClick = () => {
 // ...
}
// domçš„ç›‘å¬å’Œå–æ¶ˆç›‘å¬
onMounted(()=>{
  watchEffect((onInvalidate) => {
    document.querySelector('.btn').addEventListener('click', handleClick, false)
    onInvalidate(() => document.querySelector('.btn').removeEventListener('click', handleClick))
  })
})
```

**åœºæ™¯äºŒ**ï¼šåˆ©ç”¨watchEffectä½œä¸€ä¸ªé˜²æŠ–èŠ‚æµï¼ˆå¦‚å–æ¶ˆè¯·æ±‚ï¼‰

```js
const id = ref(13)
watchEffect(onInvalidate => {
   // å¼‚æ­¥è¯·æ±‚
  const token = performAsyncOperation(id.value)
  // å¦‚æœidé¢‘ç¹æ”¹å˜ï¼Œä¼šè§¦å‘å¤±æ•ˆå‡½æ•°ï¼Œå–æ¶ˆä¹‹å‰çš„æ¥å£è¯·æ±‚
  onInvalidate(() => {
    // id has changed or watcher is stopped.
    // invalidate previously pending async operation
    token.cancel()
  })
})
```
......

å½“ç„¶`watchEffect`è¿˜èƒ½åšå¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚æ‰“å¼€ä¸€ä¸ªä¿®æ”¹çš„`modal`å¼¹çª—ï¼Œå¦‚æœæ£€æµ‹åˆ°`id`å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`onInvalidate`å‡½æ•°å†…ï¼Œé‡ç½®åˆå§‹å‚æ•°...è¿™é‡Œåªæ˜¯ä¸€ä¸ªæŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œæœ›å¤§å®¶å¤šå¤šå‘æ˜~

ğŸš€ğŸš€ğŸš€ğŸš€ğŸš€

ç›¸å…³é˜…è¯»ï¼š[Vue3ä¸­watchçš„æœ€ä½³å®è·µ](https://zqhexor.github.io/2021/07/04/Vue3ä¸­watchçš„æœ€ä½³å®è·µ/)
